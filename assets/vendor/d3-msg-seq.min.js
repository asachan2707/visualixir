d3.messageSequence=function(){var l,f,m,p=2e3,x=250,g=[],h=[];function r(t){t.each(function(){var d=d3.select(this);d.append("marker").attr("id","msg-arrow").attr("viewBox","0 0 10 10").attr("refX","10").attr("refY","5").attr("markerWidth","5").attr("markerHeight","4").attr("orient","auto").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),d.append("g").classed("actors",!0),l=function(){if(f)m=!0;else{var t=!(f=!0),r=d.selectAll("g.message").data(g);s(r),s(r.exit());var e=d.select("g.actors").selectAll("g.actor").data(h,function(t){return t});e.exit().transition().duration(x).style("opacity",0).remove();var n=e.enter().append("g");e=e.merge(n),n.classed("actor",!0).append("text"),n.append("line"),e.select("text").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-size",function(t,r){return 1+10/(10+t.length)+"vw"}).text(function(t){return t}).attr("dy","20").transition().duration(x).attr("x",a),e.select("line").attr("data-actor",function(t){return t}).attr("y1",function(t,r){var e=this.parentNode.querySelector("text").getBBox();return e.y+e.height}).attr("y2","100%").transition().duration(x).attr("x1",a).attr("x2",a).on("end",function(){var t=r.enter().append("g").classed("message",!0);r=r.merge(t),t.each(function(t,r){var e=d3.select(this);t.from==t.to?e.append("path").attr("marker-end","url(#msg-arrow)").attr("fill-opacity",0).attr("d",function(){return u(t,r)}):e.append("line").attr("marker-end","url(#msg-arrow)").attr("x1",d.select("line[data-actor='"+t.from+"']").attr("x1")).attr("y1",50*(r+1)).attr("x2",d.select("line[data-actor='"+t.to+"']").attr("x1")).attr("y2",50*(r+1)),e.append("text").attr("text-anchor",t.from==t.to?"end":"middle").attr("alignment-baseline",t.from==t.to?"middle":"auto").text(t.msg).attr("x",function(){return i(Number.parseFloat(d.select("line[data-actor='"+t.from+"']").attr("x1")),Number.parseFloat(d.select("line[data-actor='"+t.to+"']").attr("x1")))}).attr("y",50*(r+1)-5)}),0<p&&c(),f=!1,m&&(m=!1,l())})}function a(t,r){return(r+1)*(100/(h.length+1))+"%"}function o(t){return a(0,h.indexOf(t))}function i(t,r){return r<t?(r-t)/2+t+"%":(t-r)/2+r+"%"}function u(t,r){var e,n=o(t.from);return"M "+(e=n,d.property("scrollWidth")*Number.parseFloat(e)/100)+" "+(50*(r+1)-20)+" a 40 20 0 1 "+(0==h.indexOf(t.from)?0:1)+" 0 40"}function c(){t||(t=!0,d.select("g.message").transition().duration(p).style("opacity",0).remove().on("end",function(){var r;t=!1,g.shift(),r=g.reduce(function(t,r){return t.indexOf(r.from)<0&&t.push(r.from),t.indexOf(r.to)<0&&t.push(r.to),t},[]),h=h.filter(function(t){return-1<r.indexOf(t)}),l(),0<g.length&&c()}))}function s(t){t.select("line").transition().duration(x).attr("x1",function(t){return o(t.from)}).attr("y1",function(t,r){return 50*(r+1)}).attr("x2",function(t){return o(t.to)}).attr("y2",function(t,r){return 50*(r+1)}),t.select("path").transition().duration(x).attr("d",u),t.select("text").transition().duration(x).attr("x",function(t){return i(Number.parseFloat(o(t.from)),Number.parseFloat(o(t.to)))}).attr("y",function(t,r){return 50*(r+1)-5})}}})}return r.fade=function(t){return arguments.length?(p=t,r):p},r.addMessage=function(t){return g.push(t),h.indexOf(t.from)<0&&h.push(t.from),h.indexOf(t.to)<0&&h.push(t.to),l(),r},r};
